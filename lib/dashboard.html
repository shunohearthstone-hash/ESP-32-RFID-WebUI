<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RFID Access Dashboard</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 1em; }
    table { border-collapse: collapse; width: 100%; margin-top: 1em; }
    th, td { border: 1px solid #9a9595; padding: 6px 8px; text-align: left; }
    button { margin: 1px; padding: 4px 10px; }
    #status { margin: 1vw 0; }

    /* UID / Hash layout */
    .uid-cell { display: flex; flex-direction: column; }
    .uid-main { font-size: 1em; font-weight: 600; line-height: 1.1; }
    .hash { font-size: 0.5em; color: #666; margin-top: 4px; word-break: break-all; }
    #build-info { font-size: 0.8em; color: #999; margin-top: 12px; }
  </style>
</head>
<body>
  <h2>RFID Access Control Dashboard</h2>

  <div id="status">
    <b>Last scanned:</b> <span id="last">none</span><br>
    <b>Enroll mode:</b> <span id="mode">none</span><br>
    <button onclick="setEnroll('grant')">Grant next card</button>
    <button onclick="setEnroll('revoke')">Revoke next card</button>
    <button onclick="setEnroll(null)">Cancel enroll</button>
    <button onclick="useLastScanned()">Use last scanned UID</button>
  </div>

  <form id="addForm">
    <label for="uid"></label><input id="uid" placeholder="Enter UID or scan a card">
    <label><input type="checkbox" id="auth" checked> Authorized</label>
    <button type="submit">Add / Update</button>
  </form>

  <table id="tbl">
    <thead><tr><th>UID+Hash</th><th>Authorized</th><th>Added</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <script>
    const API = "/api/cards";

    async function loadCards() {
      const res = await fetch(API);
      const data = await res.json();
      const body = document.querySelector("#tbl tbody");
      body.innerHTML = "";
      data.forEach(c => {
        // preserve server-provided `added_at` if present
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="uid-cell">
            <div class="uid-main">${c.uid}</div>
            <div class="hash">${c.uid_hash ?? ""}</div>
          </td>
          <td>${c.authorized ? "✅" : "❌"}</td>
          <td>${c.added_at ? new Date(c.added_at*1000).toLocaleString() : ''}</td>
          <td>
            <button onclick="toggleAuth('${c.uid}', ${c.authorized})">Toggle</button>
            <button onclick="del('${c.uid}')">Delete</button>
          </td>`;
        body.appendChild(tr);
      });
    }

    async function toggleAuth(uid, current) {
      await fetch(API + "/" + uid, {
        method: "PATCH",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({authorized:!current})
      });
      await loadCards();
    }

    async function del(uid) {
      if (!confirm("Delete " + uid + "?")) return;
      await fetch(API + "/" + uid, {method:"DELETE"});
      await loadCards();
    }

    document.getElementById("addForm").onsubmit = async e => {
      e.preventDefault();
      const uid = document.getElementById("uid").value.trim();
      if (!uid) {
        alert("Please enter a UID or scan a card first");
        return;
      }
      const auth = document.getElementById("auth").checked;
      await fetch(API, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({uid, authorized:auth})
      });
      document.getElementById("uid").value = "";
      await loadCards();
    }

    function useLastScanned() {
      const last = document.getElementById("last").innerText;
      if (last && last !== "none") {
        document.getElementById("uid").value = last;
      } else {
        alert("No card has been scanned yet");
      }
    }

    async function setEnroll(mode) {
      await fetch("/api/enroll", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({mode})
      });
      await updateStatus();
    }

    async function updateStatus() {
      const res = await fetch("/api/status");
      const s = await res.json();
      console.debug('[dashboard] /api/status ->', s);
      // Use server-provided values if present; otherwise show 'none'
      document.getElementById("last").innerText = s.last_scanned ? s.last_scanned : 'none';
      document.getElementById("mode").innerText = s.enroll_mode ? s.enroll_mode : 'none';
    }

    setInterval(updateStatus, 1000);
    loadCards();
    // Run immediately so page shows current status without waiting
    updateStatus();
  </script>
  <div id="build-info">Dashboard build: 2025-11-30 00:00 UTC</div>
</body>
</html>
